<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ - Izvini</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { background: #2c3e50; color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
        .back-link { color: white; text-decoration: none; background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; }
        .filters { background: #34495e; padding: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .filters select, .filters button { padding: 10px; border: none; border-radius: 5px; font-size: 14px; }
        .filters button { background: #e74c3c; color: white; cursor: pointer; }
        .filters button:hover { background: #c0392b; }
        .stats { color: white; font-weight: bold; margin-left: auto; }
        .apologies-list { padding: 20px; }
        .apology-card { 
            background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; 
            padding: 20px; margin-bottom: 15px; transition: all 0.3s;
        }
        .apology-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .apology-card.new { border-left: 4px solid #3498db; background: #ebf5fb; }
        .apology-card.approved { border-left: 4px solid #27ae60; background: #eafaf1; }
        .apology-card.rejected { border-left: 4px solid #e74c3c; background: #fdedec; }
        .apology-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }
        .apology-meta { color: #666; font-size: 0.9em; margin-bottom: 10px; }
        .apology-actions { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .btn-approve { background: #27ae60; color: white; }
        .btn-reject { background: #e74c3c; color: white; }
        .btn-delete { background: #95a5a6; color: white; }
        .status-badge { padding: 4px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold; }
        .status-new { background: #3498db; color: white; }
        .status-approved { background: #27ae60; color: white; }
        .status-rejected { background: #e74c3c; color: white; }
        .loading { text-align: center; padding: 40px; color: #666; }
        @media (max-width: 768px) {
            .filters { flex-direction: column; align-items: stretch; }
            .stats { margin-left: 0; margin-top: 10px; }
            .apology-header { flex-direction: column; align-items: flex-start; }
            .apology-actions { justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-link">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            <h1>üîß –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
            <p>–ü—Ä–æ–µ–∫—Ç "Izvini" - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–≤–∏–Ω–µ–Ω–∏—è–º–∏</p>
        </div>

        <div class="filters">
            <select id="statusFilter">
                <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                <option value="new">–ù–æ–≤—ã–µ</option>
                <option value="approved">–û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ</option>
                <option value="rejected">–û—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–µ</option>
            </select>
            <button onclick="loadApologies()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            <button onclick="exportData()">üì• –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
            <button onclick="clearAll()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
            <div class="stats" id="stats">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div class="apologies-list" id="apologiesList">
            <div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–≤–∏–Ω–µ–Ω–∏–π...</div>
        </div>
    </div>

    <script>
        const ADMIN_PASSWORD = 'admin123';

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
        if (!localStorage.getItem('adminAuthenticated')) {
            const password = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:');
            if (password !== ADMIN_PASSWORD) {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
                window.location.href = 'index.html';
            } else {
                localStorage.setItem('adminAuthenticated', 'true');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–≤–∏–Ω–µ–Ω–∏–π –∏–∑ Firebase
        async function loadApologies() {
            try {
                const snapshot = await db.collection("apologies").orderBy("timestamp", "desc").get();
                const apologies = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                displayApologies(apologies);
                updateStats(apologies);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                document.getElementById('apologiesList').innerHTML = 
                    '<div class="loading">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ.</div>';
            }
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        async function updateStatus(apologyId, newStatus) {
            try {
                await db.collection("apologies").doc(apologyId).update({
                    status: newStatus,
                    moderatedAt: new Date().toISOString()
                });
                loadApologies();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
                alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑–≤–∏–Ω–µ–Ω–∏—è
        async function deleteApology(apologyId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∏–∑–≤–∏–Ω–µ–Ω–∏–µ?')) {
                try {
                    await db.collection("apologies").doc(apologyId).delete();
                    loadApologies();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑–≤–∏–Ω–µ–Ω–∏–π
        function displayApologies(apologies) {
            const container = document.getElementById('apologiesList');
            const statusFilter = document.getElementById('statusFilter').value;
            
            if (apologies.length === 0) {
                container.innerHTML = '<div class="loading">üì≠ –ù–µ—Ç –∏–∑–≤–∏–Ω–µ–Ω–∏–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>';
                return;
            }

            let filteredApologies = statusFilter === 'all' ? apologies : 
                                  apologies.filter(a => a.status === statusFilter);

            container.innerHTML = filteredApologies.map(apology => `
                <div class="apology-card ${apology.status}">
                    <div class="apology-header">
                        <h3>üë§ –û—Ç: ${apology.name} ‚Üí –î–ª—è: ${apology.toName}</h3>
                        <span class="status-badge status-${apology.status}">
                            ${getStatusText(apology.status)}
                        </span>
                    </div>
                    <div class="apology-meta">
                        üìù –¢–∏–ø: ${getTypeText(apology.apologyType)} | 
                        üìÖ –î–∞—Ç–∞: ${new Date(apology.timestamp).toLocaleString()} |
                        üåê IP: ${apology.ip || '–Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}
                    </div>
                    <p><strong>üí¨ –ò–∑–≤–∏–Ω–µ–Ω–∏–µ:</strong> ${apology.message}</p>
                    
                    <div class="apology-actions">
                        ${apology.status === 'new' ? `
                            <button class="btn btn-approve" onclick="updateStatus('${apology.id}', 'approved')">
                                ‚úÖ –û–¥–æ–±—Ä–∏—Ç—å
                            </button>
                            <button class="btn btn-reject" onclick="updateStatus('${apology.id}', 'rejected')">
                                ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                            </button>
                        ` : ''}
                        <button class="btn btn-delete" onclick="deleteApology('${apology.id}')">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateStats(apologies) {
            const stats = {
                total: apologies.length,
                new: apologies.filter(a => a.status === 'new').length,
                approved: apologies.filter(a => a.status === 'approved').length,
                rejected: apologies.filter(a => a.status === 'rejected').length
            };
            
            document.getElementById('stats').innerHTML = 
                `üìä –í—Å–µ–≥–æ: ${stats.total} | –ù–æ–≤—ã–µ: ${stats.new} | ‚úÖ –û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ: ${stats.approved} | ‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–µ: ${stats.rejected}`;
        }

        function getStatusText(status) {
            const statuses = { 'new': '–ù–æ–≤–æ–µ', 'approved': '–û–¥–æ–±—Ä–µ–Ω–æ', 'rejected': '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ' };
            return statuses[status] || status;
        }

        function getTypeText(type) {
            const types = {
                'personal': '–õ–∏—á–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è',
                'friendship': '–î—Ä—É–∂–±–∞', 
                'family': '–°–µ–º–µ–π–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è',
                'work': '–†–∞–±–æ—á–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è'
            };
            return types[type] || type;
        }

        function exportData() {
            // –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö
            alert('–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω');
        }

        function clearAll() {
            if (confirm('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï –∏–∑–≤–∏–Ω–µ–Ω–∏—è. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
                alert('–§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞
        window.onload = loadApologies;
        document.getElementById('statusFilter').addEventListener('change', loadApologies);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ - Izvini</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="firebase-config.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { background: #2c3e50; color: white; padding: 30px; text-align: center; border-radius: 10px 10px 0 0; }
        .back-link { color: white; text-decoration: none; background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 20px; }
        .filters { background: #34495e; padding: 20px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
        .filters select, .filters button { padding: 10px; border: none; border-radius: 5px; font-size: 14px; }
        .filters button { background: #e74c3c; color: white; cursor: pointer; }
        .filters button:hover { background: #c0392b; }
        .stats { color: white; font-weight: bold; margin-left: auto; }
        .apologies-list { padding: 20px; }
        .apology-card { 
            background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; 
            padding: 20px; margin-bottom: 15px; transition: all 0.3s;
        }
        .apology-card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .apology-card.new { border-left: 4px solid #3498db; background: #ebf5fb; }
        .apology-card.approved { border-left: 4px solid #27ae60; background: #eafaf1; }
        .apology-card.rejected { border-left: 4px solid #e74c3c; background: #fdedec; }
        .apology-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }
        .apology-meta { color: #666; font-size: 0.9em; margin-bottom: 10px; }
        .apology-actions { display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap; }
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        .btn-approve { background: #27ae60; color: white; }
        .btn-reject { background: #e74c3c; color: white; }
        .btn-delete { background: #95a5a6; color: white; }
        .status-badge { padding: 4px 10px; border-radius: 15px; font-size: 0.8em; font-weight: bold; }
        .status-new { background: #3498db; color: white; }
        .status-approved { background: #27ae60; color: white; }
        .status-rejected { background: #e74c3c; color: white; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .forgiveness-requests { margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 5px; }
        .forgiveness-request { background: white; padding: 10px; margin: 5px 0; border-radius: 5px; }
        
        @media (max-width: 768px) {
            .filters { flex-direction: column; align-items: stretch; }
            .stats { margin-left: 0; margin-top: 10px; }
            .apology-header { flex-direction: column; align-items: flex-start; }
            .apology-actions { justify-content: center; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="index.html" class="back-link">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            <a href="public.html" class="back-link" style="left: 150px;">üëÄ –ü—É–±–ª–∏—á–Ω–∞—è –≥–∞–ª–µ—Ä–µ—è</a>
            <h1>üîß –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</h1>
            <p>–ü—Ä–æ–µ–∫—Ç "Izvini" - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑–≤–∏–Ω–µ–Ω–∏—è–º–∏</p>
        </div>

        <div class="filters">
            <select id="statusFilter">
                <option value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                <option value="new">–ù–æ–≤—ã–µ</option>
                <option value="approved">–û–¥–æ–±—Ä–µ–Ω–Ω—ã–µ</option>
                <option value="rejected">–û—Ç–∫–ª–æ–Ω–µ–Ω–Ω—ã–µ</option>
            </select>
            <button onclick="loadApologies()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            <button onclick="updateExistingApologies()" style="background: #9b59b6; color: white;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É</button>
            <button onclick="exportData()">üì• –≠–∫—Å–ø–æ—Ä—Ç JSON</button>
            <div class="stats" id="stats">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>

        <div class="apologies-list" id="apologiesList">
            <div class="loading">‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–≤–∏–Ω–µ–Ω–∏–π...</div>
        </div>
    </div>

    <script>
        const ADMIN_PASSWORD = 'admin123';

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è
        if (!localStorage.getItem('adminAuthenticated')) {
            const password = prompt('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:');
            if (password !== ADMIN_PASSWORD) {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
                window.location.href = 'index.html';
            } else {
                localStorage.setItem('adminAuthenticated', 'true');
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–≤–∏–Ω–µ–Ω–∏–π –∏–∑ Firebase
        async function loadApologies() {
            try {
                const snapshot = await db.collection("apologies").orderBy("timestamp", "desc").get();
                const apologies = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                displayApologies(apologies);
                updateStats(apologies);
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                document.getElementById('apologiesList').innerHTML = 
                    '<div class="loading">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</div>';
            }
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑–≤–∏–Ω–µ–Ω–∏–π
        function displayApologies(apologies) {
            const container = document.getElementById('apologiesList');
            const statusFilter = document.getElementById('statusFilter').value;
            
            if (apologies.length === 0) {
                container.innerHTML = '<div class="loading">üì≠ –ù–µ—Ç –∏–∑–≤–∏–Ω–µ–Ω–∏–π</div>';
                return;
            }

            let filteredApologies = statusFilter === 'all' ? apologies : 
                                  apologies.filter(a => a.status === statusFilter);

            container.innerHTML = filteredApologies.map(apology => `
                <div class="apology-card ${apology.status}">
                    <div class="apology-header">
                        <h3>üë§ –û—Ç: ${apology.name}</h3>
                        <div>
                            <span class="status-badge status-${apology.status}">
                                ${apology.status === 'new' ? '–ù–æ–≤–æ–µ' : 
                                 apology.status === 'approved' ? '–û–¥–æ–±—Ä–µ–Ω–æ' : '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ'}
                            </span>
                            ${apology.publiclyForgiven ? '<span style="color: #27ae60; margin-left: 10px;">üíö –ü—Ä–æ—â–µ–Ω–æ</span>' : ''}
                        </div>
                    </div>
                    
                    <div class="apology-meta">
                        üìù ${getTypeText(apology.apologyType)} | 
                        üïäÔ∏è –î–ª—è: ${apology.toName} |
                        üìÖ ${new Date(apology.timestamp).toLocaleDateString()} |
                        üíö –ü—Ä–æ—â–µ–Ω–∏–π: ${apology.totalForgiveness || 0}
                    </div>
                    
                    <p><strong>üí¨ –ò–∑–≤–∏–Ω–µ–Ω–∏–µ:</strong> ${apology.message}</p>
                    
                    <!-- –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø—Ä–æ—â–µ–Ω–∏–µ -->
                    ${apology.forgivenessRequests && apology.forgivenessRequests.length > 0 ? `
                        <div class="forgiveness-requests">
                            <strong>‚è≥ –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –ø—Ä–æ—â–µ–Ω–∏–µ:</strong>
                            ${apology.forgivenessRequests.map(req => `
                                <div class="forgiveness-request">
                                    <strong>${req.forgivenBy}:</strong> ${req.forgivenessMessage || '–ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è'}
                                    <br>
                                    <small>üìÖ ${new Date(req.timestamp).toLocaleDateString()} | 
                                    –°—Ç–∞—Ç—É—Å: ${req.status === 'pending' ? '‚è≥ –ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏' : 
                                            req.status === 'approved' ? '‚úÖ –û–¥–æ–±—Ä–µ–Ω–æ' : '‚ùå –û—Ç–∫–ª–æ–Ω–µ–Ω–æ'}</small>
                                    
                                    ${req.status === 'pending' ? `
                                        <br>
                                        <button class="btn-approve" onclick="approveForgiveness('${apology.id}', '${req.id}')" style="padding: 5px 10px; font-size: 12px;">
                                            ‚úÖ –û–¥–æ–±—Ä–∏—Ç—å
                                        </button>
                                        <button class="btn-reject" onclick="rejectForgiveness('${apology.id}', '${req.id}')" style="padding: 5px 10px; font-size: 12px;">
                                            ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                        </button>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="apology-actions">
                        ${apology.status === 'new' ? `
                            <button class="btn btn-approve" onclick="updateStatus('${apology.id}', 'approved')">
                                ‚úÖ –û–¥–æ–±—Ä–∏—Ç—å
                            </button>
                            <button class="btn btn-reject" onclick="updateStatus('${apology.id}', 'rejected')">
                                ‚ùå –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                            </button>
                        ` : ''}
                        
                        <button class="btn btn-delete" onclick="deleteApology('${apology.id}')">
                            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
        async function updateStatus(apologyId, newStatus) {
            try {
                const updateData = {
                    status: newStatus,
                    moderatedAt: new Date().toISOString()
                };
                
                // –ï—Å–ª–∏ –æ–¥–æ–±—Ä—è–µ–º - –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –ø–æ–ª—è
                if (newStatus === 'approved') {
                    const apologyDoc = await db.collection("apologies").doc(apologyId).get();
                    const apologyData = apologyDoc.data();
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—è –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
                    if (!apologyData.forgivenessRequests) {
                        updateData.forgivenessRequests = [];
                    }
                    if (typeof apologyData.totalForgiveness === 'undefined') {
                        updateData.totalForgiveness = 0;
                    }
                    if (typeof apologyData.publiclyForgiven === 'undefined') {
                        updateData.publiclyForgiven = false;
                    }
                }
                
                await db.collection("apologies").doc(apologyId).update(updateData);
                loadApologies();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
                alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞');
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ –∏–∑–≤–∏–Ω–µ–Ω–∏—è
        async function deleteApology(apologyId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ –∏–∑–≤–∏–Ω–µ–Ω–∏–µ?')) {
                try {
                    await db.collection("apologies").doc(apologyId).delete();
                    loadApologies();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è');
                }
            }
        }

        // –û–¥–æ–±—Ä–∏—Ç—å –ø—Ä–æ—â–µ–Ω–∏–µ
        async function approveForgiveness(apologyId, requestId) {
            try {
                const apologyDoc = await db.collection("apologies").doc(apologyId).get();
                const apologyData = apologyDoc.data();
                
                const updatedRequests = apologyData.forgivenessRequests.map(req => 
                    req.id === requestId ? { ...req, status: 'approved' } : req
                );
                
                const approvedCount = updatedRequests.filter(req => req.status === 'approved').length;
                
                await db.collection("apologies").doc(apologyId).update({
                    forgivenessRequests: updatedRequests,
                    totalForgiveness: approvedCount,
                    publiclyForgiven: approvedCount > 0
                });
                
                loadApologies();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–¥–æ–±—Ä–µ–Ω–∏–∏ –ø—Ä–æ—â–µ–Ω–∏—è');
            }
        }

        // –û—Ç–∫–ª–æ–Ω–∏—Ç—å –ø—Ä–æ—â–µ–Ω–∏–µ
        async function rejectForgiveness(apologyId, requestId) {
            if (confirm('–û—Ç–∫–ª–æ–Ω–∏—Ç—å —ç—Ç–æ –ø—Ä–æ—â–µ–Ω–∏–µ?')) {
                try {
                    const apologyDoc = await db.collection("apologies").doc(apologyId).get();
                    const apologyData = apologyDoc.data();
                    
                    const updatedRequests = apologyData.forgivenessRequests.map(req => 
                        req.id === requestId ? { ...req, status: 'rejected' } : req
                    );
                    
                    await db.collection("apologies").doc(apologyId).update({
                        forgivenessRequests: updatedRequests
                    });
                    
                    loadApologies();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–∏ –ø—Ä–æ—â–µ–Ω–∏—è');
                }
            }
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∏–∑–≤–∏–Ω–µ–Ω–∏—è
        async function updateExistingApologies() {
            if (confirm('–î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –ø—Ä–æ—â–µ–Ω–∏–π –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∏–∑–≤–∏–Ω–µ–Ω–∏—è–º?')) {
                try {
                    const snapshot = await db.collection("apologies").get();
                    const promises = [];
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const updateData = {};
                        
                        if (!data.forgivenessRequests) {
                            updateData.forgivenessRequests = [];
                        }
                        if (typeof data.totalForgiveness === 'undefined') {
                            updateData.totalForgiveness = 0;
                        }
                        if (typeof data.publiclyForgiven === 'undefined') {
                            updateData.publiclyForgiven = false;
                        }
                        
                        if (Object.keys(updateData).length > 0) {
                            promises.push(db.collection("apologies").doc(doc.id).update(updateData));
                        }
                    });
                    
                    await Promise.all(promises);
                    alert('‚úÖ –ò–∑–≤–∏–Ω–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã!');
                    loadApologies();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏');
                }
            }
        }

        // –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö
        function exportData() {
            db.collection("apologies").get().then(snapshot => {
                const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = 'apologies_export.json';
                link.click();
            });
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
        function updateStats(apologies) {
            const stats = {
                total: apologies.length,
                new: apologies.filter(a => a.status === 'new').length,
                approved: apologies.filter(a => a.status === 'approved').length,
                rejected: apologies.filter(a => a.status === 'rejected').length,
                forgivenessRequests: apologies.reduce((sum, a) => sum + (a.forgivenessRequests ? a.forgivenessRequests.length : 0), 0)
            };
            
            document.getElementById('stats').innerHTML = 
                `üìä –í—Å–µ–≥–æ: ${stats.total} | –ù–æ–≤—ã–µ: ${stats.new} | ‚úÖ: ${stats.approved} | ‚ùå: ${stats.rejected} | üíö –ó–∞–ø—Ä–æ—Å–æ–≤: ${stats.forgivenessRequests}`;
        }

        function getTypeText(type) {
            const types = {
                'personal': '–õ–∏—á–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è',
                'friendship': '–î—Ä—É–∂–±–∞',
                'family': '–°–µ–º–µ–π–Ω—ã–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è',
                'work': '–†–∞–±–æ—á–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è'
            };
            return types[type] || type;
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏
        window.onload = loadApologies;
        document.getElementById('statusFilter').addEventListener('change', loadApologies);
    </script>
</body>
</html>